#!/usr/bin/env python
import pyclamd
import boto3
import pprint
import sys
import argparse
import logging as log
import os
import threading

sema = threading.Semaphore(value=9) # Boto3 has a limit of 10 parallel connections
threads = list()

def __file_check(s3_res, bucketname, object_key):
    sema.acquire()

    obj = s3_res.Object(bucketname, object_key)
    data = obj.get()

    log.info("Scanning: {type} {length} {key}".format(key=object_key, type=data['ContentType'], length=data['ContentLength']))

    clamd = pyclamd.ClamdNetworkSocket(host=args.clamd_host, port=int(args.clamd_port), timeout=None)
    result = clamd.scan_stream(data['Body'].read())
    if result != None:
        print("\x1b[31;21mMalware found: {type} {length} {key} {malware}\x1b[0m".format(
            key=object_key, 
            type=data['ContentType'], 
            length=data['ContentLength'],
            malware=result['stream'][1]
        ))
    
    sema.release()

def __scanner(bucketname):

    s3 = boto3.client("s3")
    all_objects = s3.list_objects(Bucket = bucketname) 

    s3_res = boto3.resource('s3')
    for s3file in all_objects['Contents']:
        x = threading.Thread(target=__file_check, args=(s3_res, bucketname, s3file['Key']))
        threads.append(x)
        x.start()

    for y in threads:
        y.join()

    print('DONE')

if __name__ == '__main__':

    parser = argparse.ArgumentParser()
    parser.add_argument("-v", "--verbose", action='store_true', required=False, help="increase output verbosity")
    parser.add_argument("-vv", "--veryverbose", action='store_true', required=False, help="increase output verbosity")
    parser.add_argument("-b", "--aws_bucket", required=True, help="Bucket name")
    parser.add_argument("-c", "--clamd_host", default=os.environ.get('CLAMD_HOST', '127.0.0.1'), required=False, help="Host or IP of clamd Server")
    parser.add_argument("-p", "--clamd_port", default=os.environ.get('CLAMD_PORT', '3310'), required=False, help="Port of clamd Server")

    args = parser.parse_args()

    if args.verbose:
        log.basicConfig(format='%(levelname)s:%(message)s', level=log.INFO)

    if args.veryverbose:
        log.basicConfig(format='%(levelname)s:%(message)s', level=log.DEBUG)


    log.info("Clamd Host: {}:{}".format(args.clamd_host, args.clamd_port))

    try:
        __scanner(args.aws_bucket)
    except KeyboardInterrupt:
        print('EXIT: User aborted scan')
    
    sys.exit()